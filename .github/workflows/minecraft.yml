name: Minecraft Updates to Discord

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Descargar p√°gina de art√≠culos
        run: |
          curl -L -A "Mozilla/5.0" https://www.minecraft.net/en-us/articles > page.html

      - name: Extraer enlaces v√°lidos
        run: |
          grep -o 'https://www.minecraft.net/en-us/articles/[0-9A-Za-z-]*' page.html \
          | grep -v Feedback-and-Fan-Mail \
          | grep -v Marketplace \
          | sort -u > links.txt

      - name: Obtener art√≠culo m√°s reciente
        run: |
          LINK=$(head -n 1 links.txt)

          if [ -z "$LINK" ]; then
            echo "No hay art√≠culos"
            exit 0
          fi

          ID=$(echo "$LINK" | awk -F/ '{print $NF}')

          echo "$LINK" > current_link.txt
          echo "$ID" > current_id.txt

      - name: Verificar si ya fue enviado
        run: |
          if [ -f last_id.txt ]; then
            if [ "$(cat last_id.txt)" = "$(cat current_id.txt)" ]; then
              echo "Art√≠culo ya enviado"
              exit 0
            fi
          fi

      - name: Enviar a Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          LINK=$(cat current_link.txt)

          curl -X POST "$WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "{
            \"content\": \"üì∞ **Nueva noticia de Minecraft**\\n$LINK\"
          }"

      - name: Guardar √∫ltimo art√≠culo enviado
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mv current_id.txt last_id.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add last_id.txt
          git commit -m "Actualizar √∫ltimo art√≠culo enviado" || exit 0
          git push
