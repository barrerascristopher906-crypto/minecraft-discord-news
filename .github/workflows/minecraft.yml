name: Minecraft News to Discord

on:
  schedule:
    - cron: "0 */4 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Descargar art√≠culos
      - name: Descargar p√°gina de art√≠culos
        run: |
          curl -L -A "Mozilla/5.0" https://www.minecraft.net/en-us/articles > page.html

      # 2Ô∏è‚É£ Extraer links
      - name: Extraer links
        run: |
          grep -o 'href="/en-us/article/[^"]*"' page.html \
          | sed 's/href="//;s/"//' \
          | sort -u > links.txt

      # 3Ô∏è‚É£ Buscar art√≠culo reciente
      - name: Buscar art√≠culo reciente
        run: |
          TODAY=$(date +%s)
          FOUND=0

          while read LINK; do
            URL="https://www.minecraft.net$LINK"
            curl -s -L -A "Mozilla/5.0" "$URL" > article.html

            DATE=$(grep -m1 'property="article:published_time"' article.html | sed 's/.*content="//;s/".*//')
            [ -z "$DATE" ] && continue

            ARTICLE_TIME=$(date -d "$DATE" +%s)
            DIFF=$(( (TODAY - ARTICLE_TIME) / 86400 ))

            if [ "$DIFF" -le 7 ]; then
              echo "$URL" > current_link.txt
              echo "$DATE" > current_date.txt
              FOUND=1
              break
            fi
          done < links.txt

          if [ "$FOUND" -eq 0 ]; then
            echo "SEND=false" >> $GITHUB_ENV
            exit 0
          fi

      # 4Ô∏è‚É£ Generar ID
      - name: Generar ID
        run: |
          echo "$(cat current_link.txt)|$(cat current_date.txt)" > current_id.txt

      # 5Ô∏è‚É£ Anti-spam REAL
      - name: Verificar si ya fue enviado
        run: |
          if [ -f last_id.txt ] && cmp -s current_id.txt last_id.txt; then
            echo "SEND=false" >> $GITHUB_ENV
          else
            echo "SEND=true" >> $GITHUB_ENV
          fi

      # 6Ô∏è‚É£ Guardar nuevo ID
      - name: Guardar ID
        if: env.SEND == 'true'
        run: |
          mv current_id.txt last_id.txt

      # 7Ô∏è‚É£ Extraer t√≠tulo
      - name: Extraer t√≠tulo
        if: env.SEND == 'true'
        run: |
          grep -m1 "<h1" article.html | sed 's/<[^>]*>//g' > title.txt

      # 8Ô∏è‚É£ Enviar a Discord
      - name: Enviar a Discord
        if: env.SEND == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TITLE=$(cat title.txt)
          LINK=$(cat current_link.txt)

          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"üü¢ **Nueva noticia de Minecraft**\nüì∞ $TITLE\nüîó $LINK\"}" \
          $DISCORD_WEBHOOK

      # 9Ô∏è‚É£ Commit estado
      - name: Guardar estado
        if: env.SEND == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add last_id.txt
          git commit -m "Actualizar √∫ltima noticia enviada" || echo "Sin cambios"
          git push
