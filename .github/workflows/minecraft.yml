name: Minecraft RSS to Discord

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  rss:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Descargar RSS oficial
        run: |
          curl -s https://www.minecraft.net/en-us/feeds/news.xml > feed.xml

      - name: Extraer primer item real
        run: |
          TITLE=$(awk '
            /<item>/,/<\/item>/ {
              if ($0 ~ /<title>/) {
                gsub(/.*<title>|<\/title>.*/, "", $0)
                print $0
                exit
              }
            }' feed.xml)

          LINK=$(awk '
            /<item>/,/<\/item>/ {
              if ($0 ~ /<link>/) {
                gsub(/.*<link>|<\/link>.*/, "", $0)
                print $0
                exit
              }
            }' feed.xml)

          if [ -z "$TITLE" ] || [ -z "$LINK" ]; then
            echo "No se pudo extraer noticia v√°lida"
            exit 0
          fi

          echo "$TITLE" > current_title.txt
          echo "$LINK" > current_link.txt
          echo "$LINK" | md5sum | awk "{print \$1}" > current_id.txt

      - name: Verificar si ya fue enviado
        run: |
          if [ -f last_id.txt ]; then
            if [ "$(cat last_id.txt)" = "$(cat current_id.txt)" ]; then
              echo "Noticia ya enviada"
              exit 0
            fi
          fi

      - name: Enviar notificaci√≥n a Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TITLE=$(cat current_title.txt)
          LINK=$(cat current_link.txt)

          if [ -z "$LINK" ]; then
            echo "Link vac√≠o, no se env√≠a"
            exit 0
          fi

          curl -s -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"üì∞ **$TITLE**\\n$LINK\"
            }"

      - name: Guardar √∫ltima noticia enviada
        run: |
          mv current_id.txt last_id.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add last_id.txt
          git commit -m "Actualizar √∫ltima noticia" || exit 0
          git push
