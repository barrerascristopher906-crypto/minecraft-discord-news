name: Minecraft Updates to Discord

on:
  schedule:
    - cron: "0 * * * *" # cada hora
  workflow_dispatch:

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Descargar pÃ¡gina de artÃ­culos
        run: |
          curl -s -L -A "Mozilla/5.0" https://www.minecraft.net/en-us/articles > page.html

      - name: Extraer artÃ­culo mÃ¡s reciente
        run: |
          grep -o '/en-us/articles/[^"]*' page.html | head -n 1 > current_link.txt

          if [ ! -s current_link.txt ]; then
            echo "SEND=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "https://www.minecraft.net$(cat current_link.txt)" > full_link.txt
          echo "SEND=true" >> $GITHUB_ENV

      - name: Generar ID
        run: |
          sha256sum full_link.txt | cut -d' ' -f1 > current_id.txt

      - name: Verificar si ya fue enviado
        run: |
          if [ -f last_id.txt ]; then
            if cmp -s current_id.txt last_id.txt; then
              echo "SEND=false" >> $GITHUB_ENV
            fi
          fi

      - name: Enviar a Discord
        if: env.SEND == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"ðŸ“° **Nueva noticia de Minecraft**\\nðŸ”— $(cat full_link.txt)\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Guardar Ãºltimo artÃ­culo enviado
        if: env.SEND == 'true'
        run: |
          mv current_id.txt last_id.txt
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add last_id.txt
          git commit -m "Actualizar Ãºltimo artÃ­culo enviado" || true
          git push
