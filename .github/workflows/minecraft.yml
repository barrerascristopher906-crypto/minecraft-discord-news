name: Minecraft Updates to Discord

on:
  schedule:
    - cron: "0 * * * *" # cada hora
  workflow_dispatch:

jobs:
  check_updates:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Descargar pÃ¡gina de artÃ­culos
        run: |
          curl -s -L -A "Mozilla/5.0" https://www.minecraft.net/en-us/articles > page.html

      - name: Extraer links
        run: |
          grep -o '/en-us/articles/[^"]*' page.html | sort -u > links.txt

      - name: Buscar artÃ­culo mÃ¡s reciente
        run: |
          BEST_TIME=0
          BEST_LINK=""
          BEST_DATE=""

          while read LINK; do
            URL="https://www.minecraft.net$LINK"
            curl -s -L -A "Mozilla/5.0" "$URL" > article.html

            DATE=$(grep -m1 'article:published_time' article.html | sed -n 's/.*content="\([^"]*\)".*/\1/p')

            # Si no hay fecha, saltar
            if [ -z "$DATE" ]; then
              continue
            fi

            # Validar fecha
            if ! TIME=$(date -d "$DATE" +%s 2>/dev/null); then
              continue
            fi

            # Solo artÃ­culos recientes (7 dÃ­as)
            AGE=$(( ($(date +%s) - TIME) / 86400 ))
            if [ "$AGE" -le 7 ] && [ "$TIME" -gt "$BEST_TIME" ]; then
              BEST_TIME="$TIME"
              BEST_LINK="$URL"
              BEST_DATE="$DATE"
            fi
          done < links.txt

          if [ -z "$BEST_LINK" ]; then
            echo "SEND=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "$BEST_LINK" > current_link.txt
          echo "$BEST_DATE" > current_date.txt
          echo "SEND=true" >> $GITHUB_ENV

      - name: Generar ID
        run: |
          sha256sum current_link.txt | cut -d' ' -f1 > current_id.txt

      - name: Verificar si ya fue enviado
        run: |
          if [ -f last_id.txt ]; then
            if cmp -s current_id.txt last_id.txt; then
              echo "SEND=false" >> $GITHUB_ENV
            fi
          fi

      - name: Enviar a Discord
        if: env.SEND == 'true'
        run: |
          curl -H "Content-Type: application/json" \
               -d "{\"content\":\"ðŸ“° **Nueva noticia de Minecraft**\\nðŸ”— $(cat current_link.txt)\"}" \
               ${{ secrets.DISCORD_WEBHOOK }}

      - name: Guardar Ãºltimo artÃ­culo enviado
        if: env.SEND == 'true'
        run: |
          mv current_id.txt last_id.txt
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add last_id.txt
          git commit -m "Actualizar Ãºltimo artÃ­culo enviado" || true
          git push
