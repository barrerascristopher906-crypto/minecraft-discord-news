name: Minecraft News to Discord

on:
  schedule:
    - cron: "0 * * * *"   # Cada hora (seguro)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Descargar p√°gina de art√≠culos
      - name: Descargar p√°gina de art√≠culos
        run: |
          curl -L --http1.1 -A "Mozilla/5.0" \
          https://www.minecraft.net/en-us/articles > page.html

      # 2Ô∏è‚É£ Extraer link del art√≠culo m√°s reciente
      - name: Extraer link del art√≠culo m√°s reciente
        run: |
          LINK=$(grep -o 'href="/en-us/article/[^"]*"' page.html | head -n 1 | sed 's/href="//;s/"//')
          FULL_LINK="https://www.minecraft.net$LINK"
          echo "$FULL_LINK" > current_link.txt

      # 3Ô∏è‚É£ Comparar con el √∫ltimo link enviado (ANTI-SPAM)
      - name: Comparar con √∫ltimo art√≠culo enviado
        run: |
          if [ -f last_link.txt ]; then
            if cmp -s current_link.txt last_link.txt; then
              echo "No hay noticia nueva"
              exit 0
            fi
          fi

      # 4Ô∏è‚É£ Guardar nuevo link
      - name: Guardar nuevo link
        run: |
          mv current_link.txt last_link.txt

      # 5Ô∏è‚É£ Descargar el art√≠culo nuevo
      - name: Descargar art√≠culo nuevo
        run: |
          LINK=$(cat last_link.txt)
          curl -L --http1.1 -A "Mozilla/5.0" "$LINK" > article.html

      # 6Ô∏è‚É£ Extraer t√≠tulo real del art√≠culo
      - name: Extraer t√≠tulo real
        run: |
          TITLE=$(grep -m1 "<h1" article.html | sed 's/<[^>]*>//g')
          echo "$TITLE" > title.txt

      # 7Ô∏è‚É£ Enviar mensaje a Discord
      - name: Enviar mensaje a Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TITLE=$(cat title.txt)
          LINK=$(cat last_link.txt)
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"üü© **Minecraft Update**\nüì∞ $TITLE\nüîó $LINK\"}" \
          $DISCORD_WEBHOOK

      # 8Ô∏è‚É£ Guardar estado para evitar spam
      - name: Guardar estado en el repo
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add last_link.txt
          git commit -m "Actualizar √∫ltima noticia" || echo "Sin cambios"
          git push
