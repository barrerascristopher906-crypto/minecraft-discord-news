name: Minecraft News to Discord

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"   # cada hora
  workflow_dispatch:

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Descargar p치gina de art칤culos
        run: |
          curl -L -A "Mozilla/5.0" https://www.minecraft.net/en-us/articles > page.html

      - name: Extraer enlaces v치lidos
        run: |
          grep -o 'href="/en-us/articles/[0-9]\+-[^"]*"' page.html \
          | sed 's/href="//;s/"//' \
          | grep -vi 'feedback' \
          | grep -vi 'fan-mail' \
          | grep -vi 'community' \
          | grep -vi 'marketplace' \
          | awk '{print "https://www.minecraft.net"$0}' \
          | sort -u > links.txt

      - name: Inicializar archivos temporales
        run: |
          : > current_link.txt
          : > current_id.txt

      - name: Obtener primer art칤culo NUEVO
        run: |
          if [ ! -s links.txt ]; then
            echo "No hay enlaces"
            exit 0
          fi

          FOUND=0
          while read LINK; do
            ID=$(echo "$LINK" | grep -o '[0-9]\+' | head -n 1)

            if [ -z "$ID" ]; then
              continue
            fi

            if [ -f last_id.txt ] && grep -q "^$ID$" last_id.txt; then
              continue
            fi

            echo "$LINK" > current_link.txt
            echo "$ID" > current_id.txt
            FOUND=1
            break
          done < links.txt

          if [ "$FOUND" = "0" ]; then
            echo "No hay art칤culos nuevos"
            exit 0
          fi

      - name: Validar art칤culo
        run: |
          if [ ! -s current_link.txt ] || [ ! -s current_id.txt ]; then
            echo "Art칤culo inv치lido"
            exit 0
          fi

      - name: Enviar notificaci칩n a Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          LINK=$(cat current_link.txt)

          if [ -z "$LINK" ]; then
            echo "Link vac칤o, no se env칤a"
            exit 0
          fi

          curl -s -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"游닗 **Nueva noticia de Minecraft**\\n$LINK\"
            }"

      - name: Guardar 칰ltimo art칤culo enviado
        run: |
          mv current_id.txt last_id.txt

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add last_id.txt
          git commit -m "Actualizar 칰ltimo art칤culo enviado" || exit 0
          git push
