name: Minecraft News to Discord

permissions:
  contents: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  minecraft:
    runs-on: ubuntu-latest
    timeout-minutes: 3   # evita que se quede colgado

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Descargar RSS espejo (estable)
        run: |
          wget -q -O feed.xml https://raw.githubusercontent.com/InventivetalentDev/minecraft-assets/main/rss/news.xml

      - name: Extraer Ãºltima noticia
        run: |
          TITLE=$(awk -F'[<>]' '/<item>/{f=1} f && /<title>/{print $3; exit}' feed.xml)
          LINK=$(awk -F'[<>]' '/<item>/{f=1} f && /<link>/{print $3; exit}' feed.xml)

          if [ -z "$TITLE" ] || [ -z "$LINK" ]; then
            echo "No se encontrÃ³ noticia"
            exit 0
          fi

          echo "$TITLE" > current_title.txt
          echo "$LINK" > current_link.txt
          echo "$LINK" | sha1sum | awk '{print $1}' > current_id.txt

      - name: Verificar duplicado
        run: |
          if [ -f last_id.txt ] && diff last_id.txt current_id.txt >/dev/null; then
            echo "Noticia ya enviada"
            exit 0
          fi

      - name: Enviar a Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -s -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ðŸ“° **$(cat current_title.txt)**\n$(cat current_link.txt)\"
            }"

      - name: Guardar ID
        run: |
          mv current_id.txt last_id.txt
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add last_id.txt
          git commit -m \"Actualizar Ãºltima noticia\" || exit 0
          git push
