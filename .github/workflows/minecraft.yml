name: Minecraft News to Discord

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-news:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1Ô∏è‚É£ Descargar p√°gina de art√≠culos
      - name: Descargar p√°gina de art√≠culos
        run: |
          curl -L --http1.1 -A "Mozilla/5.0" \
          https://www.minecraft.net/en-us/articles > page.html

      # 2Ô∏è‚É£ Extraer SOLO art√≠culos recientes (2024+)
      - name: Extraer art√≠culo reciente
        run: |
          grep -o 'href="/en-us/article/[^"]*"' page.html \
          | sed 's/href="//;s/"//' \
          | while read LINK; do
              FULL="https://www.minecraft.net$LINK"
              curl -s -L --http1.1 -A "Mozilla/5.0" "$FULL" > tmp.html
              if grep -qE "2024|2025|2026" tmp.html; then
                echo "$FULL" > current_link.txt
                break
              fi
            done

      # 3Ô∏è‚É£ Verificar que se encontr√≥ algo
      - name: Verificar art√≠culo v√°lido
        run: |
          if [ ! -f current_link.txt ]; then
            echo "No se encontr√≥ art√≠culo reciente"
            exit 0
          fi

      # 4Ô∏è‚É£ Anti-spam
      - name: Comparar con √∫ltimo art√≠culo enviado
        run: |
          if [ -f last_link.txt ]; then
            if cmp -s current_link.txt last_link.txt; then
              echo "No hay noticia nueva"
              exit 0
            fi
          fi

      # 5Ô∏è‚É£ Guardar nuevo link
      - name: Guardar nuevo link
        run: |
          mv current_link.txt last_link.txt

      # 6Ô∏è‚É£ Descargar art√≠culo
      - name: Descargar art√≠culo
        run: |
          curl -L --http1.1 -A "Mozilla/5.0" "$(cat last_link.txt)" > article.html

      # 7Ô∏è‚É£ Extraer t√≠tulo real
      - name: Extraer t√≠tulo
        run: |
          grep -m1 "<h1" article.html | sed 's/<[^>]*>//g' > title.txt

      # 8Ô∏è‚É£ Enviar a Discord
      - name: Enviar mensaje a Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          TITLE=$(cat title.txt)
          LINK=$(cat last_link.txt)
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\":\"üü¢ **Nueva noticia de Minecraft**\nüì∞ $TITLE\nüîó $LINK\"}" \
          $DISCORD_WEBHOOK

      # 9Ô∏è‚É£ Guardar estado
      - name: Guardar estado
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add last_link.txt
          git commit -m "Actualizar √∫ltima noticia" || echo "Sin cambios"
          git push
